# Document Relevance Verification - System Flow Diagram

## Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND (React/Next.js)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  User Selects File                                           â”‚     â”‚
â”‚  â”‚  â”œâ”€ File: medical_report.pdf                                 â”‚     â”‚
â”‚  â”‚  â”œâ”€ Document Type: "medical_report"                          â”‚     â”‚
â”‚  â”‚  â””â”€ Document Name: "×ª×¢×•×“×” ×¨×¤×•××™×ª ××”×¨×•×¤× ×”××˜×¤×œ"              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  uploadDocument()                                            â”‚     â”‚
â”‚  â”‚  (from useDocumentUploadWithRelevance hook)                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                       API Call (multipart/form-data)
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BACKEND (FastAPI/Python)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  POST /cases/{case_id}/documents                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 1. Validate Access & File Type                               â”‚     â”‚
â”‚  â”‚    â”œâ”€ Check user permissions                                 â”‚     â”‚
â”‚  â”‚    â”œâ”€ Verify PDF/image format                                â”‚     â”‚
â”‚  â”‚    â””â”€ Validate file size                                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 2. Extract Text (OCR)                                        â”‚     â”‚
â”‚  â”‚    â””â”€ extract_text_from_document()                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 3. Analyze Document                                          â”‚     â”‚
â”‚  â”‚    â””â”€ summarize_dashboard_document()                         â”‚     â”‚
â”‚  â”‚       â”œâ”€ document_summary                                    â”‚     â”‚
â”‚  â”‚       â”œâ”€ key_points                                          â”‚     â”‚
â”‚  â”‚       â””â”€ structured_data (diagnoses, meds, etc.)            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 4. Upload to Supabase Storage                                â”‚     â”‚
â”‚  â”‚    â””â”€ storage_upload_file()                                  â”‚     â”‚
â”‚  â”‚       Path: cases/{case_id}/documents/{timestamp}_{file}     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 5. Run Relevance Check â˜… NEW â˜…                              â”‚     â”‚
â”‚  â”‚    â””â”€ check_document_relevance()                             â”‚     â”‚
â”‚  â”‚       (document_relevance_checker_agent.py)                  â”‚     â”‚
â”‚  â”‚                                                              â”‚     â”‚
â”‚  â”‚    Input:                                                    â”‚     â”‚
â”‚  â”‚    â”œâ”€ Document summary                                       â”‚     â”‚
â”‚  â”‚    â”œâ”€ Key points                                            â”‚     â”‚
â”‚  â”‚    â”œâ”€ Structured data                                       â”‚     â”‚
â”‚  â”‚    â”œâ”€ Required doc spec (from call_summary)                 â”‚     â”‚
â”‚  â”‚    â””â”€ OCR text sample                                       â”‚     â”‚
â”‚  â”‚                                                              â”‚     â”‚
â”‚  â”‚    OpenAI GPT-4 Analysis:                                   â”‚     â”‚
â”‚  â”‚    â”œâ”€ Compare content vs requirements                       â”‚     â”‚
â”‚  â”‚    â”œâ”€ Check document type match                             â”‚     â”‚
â”‚  â”‚    â”œâ”€ Verify source correctness                             â”‚     â”‚
â”‚  â”‚    â”œâ”€ Assess completeness                                   â”‚     â”‚
â”‚  â”‚    â””â”€ BTL compliance check                                  â”‚     â”‚
â”‚  â”‚                                                              â”‚     â”‚
â”‚  â”‚    Output:                                                   â”‚     â”‚
â”‚  â”‚    â”œâ”€ is_relevant: bool                                     â”‚     â”‚
â”‚  â”‚    â”œâ”€ confidence: 0-100                                     â”‚     â”‚
â”‚  â”‚    â”œâ”€ detailed_analysis (Hebrew)                            â”‚     â”‚
â”‚  â”‚    â”œâ”€ missing_items: [...]                                  â”‚     â”‚
â”‚  â”‚    â”œâ”€ recommendations                                       â”‚     â”‚
â”‚  â”‚    â””â”€ matched_aspects: [...]                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                          â”‚
â”‚                    Decision Gate: Confidence?                          â”‚
â”‚                       /                    \                            â”‚
â”‚               confidence > 60         confidence â‰¤ 60                  â”‚
â”‚                      â†“                        â†“                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ 6a. Save to Database    â”‚    â”‚ 6b. Return Confirmation Req  â”‚     â”‚
â”‚  â”‚     insert_case_documentâ”‚    â”‚     status: needs_confirmationâ”‚     â”‚
â”‚  â”‚     â†“                    â”‚    â”‚     + relevance_check        â”‚     â”‚
â”‚  â”‚ 7. Update call_summary  â”‚    â”‚     + temp_storage_info      â”‚     â”‚
â”‚  â”‚     documents_requested â”‚    â”‚                              â”‚     â”‚
â”‚  â”‚     _list               â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”‚     â†“                    â”‚                   â”‚                      â”‚
â”‚  â”‚ 8. Return Success       â”‚                   â”‚                      â”‚
â”‚  â”‚     {status: "ok", ...} â”‚                   â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚                      â”‚
â”‚                 â”‚                               â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                               â”‚
                  â”‚                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND (React/Next.js)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Success Path                    Confirmation Path                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Show Success     â”‚            â”‚ Show DocumentRelevance     â”‚       â”‚
â”‚  â”‚ Toast            â”‚            â”‚ Dialog                     â”‚       â”‚
â”‚  â”‚                  â”‚            â”‚                            â”‚       â”‚
â”‚  â”‚ Refresh UI       â”‚            â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚                  â”‚            â”‚ â”‚ Confidence Badge    â”‚   â”‚       â”‚
â”‚  â”‚ Update Documents â”‚            â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚       â”‚
â”‚  â”‚ List             â”‚            â”‚ â”‚ â”‚   65% Match     â”‚ â”‚   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚       â”‚
â”‚                                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚                                   â”‚                            â”‚       â”‚
â”‚                                   â”‚ âœ… Matched Aspects         â”‚       â”‚
â”‚                                   â”‚ âŒ Missing Items           â”‚       â”‚
â”‚                                   â”‚ ğŸ’¡ Recommendations         â”‚       â”‚
â”‚                                   â”‚                            â”‚       â”‚
â”‚                                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚       â”‚
â”‚                                   â”‚ â”‚ Upload   â”‚ â”‚ Cancel & â”‚â”‚       â”‚
â”‚                                   â”‚ â”‚ Anyway   â”‚ â”‚ Re-uploadâ”‚â”‚       â”‚
â”‚                                   â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚       â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                          â”‚             â”‚              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚              â†“                                                  â†“     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ confirmUpload()       â”‚                    â”‚ rejectUpload()   â”‚   â”‚
â”‚  â”‚ Re-upload with        â”‚                    â”‚ Delete temp file â”‚   â”‚
â”‚  â”‚ confirmed=true        â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚             â”‚
â”‚              â”‚                                         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                         â”‚
               â”‚ API Call                                â”‚ API Call
               â”‚ (confirmed=true)                        â”‚ DELETE
               â†“                                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BACKEND (FastAPI/Python)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  POST /cases/{case_id}/documents           DELETE /temp             â”‚
â”‚  (confirmed=true)                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Skip relevance check â”‚                 â”‚ storage_delete_fileâ”‚   â”‚
â”‚  â”‚ â†“                     â”‚                 â”‚ â†“                  â”‚   â”‚
â”‚  â”‚ Save to DB           â”‚                 â”‚ Remove from        â”‚   â”‚
â”‚  â”‚ â†“                     â”‚                 â”‚ Supabase Storage   â”‚   â”‚
â”‚  â”‚ Update call_summary  â”‚                 â”‚ â†“                  â”‚   â”‚
â”‚  â”‚ â†“                     â”‚                 â”‚ Return success     â”‚   â”‚
â”‚  â”‚ Return success       â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

## Key Components

### Backend Components
```
document_relevance_checker_agent.py
â”œâ”€ check_document_relevance()
â”‚  â”œâ”€ Uses OpenAI GPT-4 with structured output
â”‚  â”œâ”€ Compares document vs requirements
â”‚  â””â”€ Returns confidence + detailed analysis
â”‚
main.py
â”œâ”€ upload_case_document() [MODIFIED]
â”‚  â”œâ”€ Added: confirmed parameter
â”‚  â”œâ”€ Added: Relevance checking logic
â”‚  â””â”€ Added: Decision gate (confidence > 60)
â”‚
â””â”€ delete_temp_document() [NEW]
   â””â”€ Deletes rejected files from storage

supabase_client.py
â””â”€ storage_delete_file() [NEW]
   â””â”€ Utility to delete from Supabase Storage
```

### Frontend Components
```
hooks/use-document-upload-with-relevance.ts
â”œâ”€ uploadDocument()
â”‚  â””â”€ Initial upload (confirmed=false)
â”œâ”€ confirmUpload()
â”‚  â””â”€ Re-upload with confirmed=true
â”œâ”€ rejectUpload()
â”‚  â””â”€ Delete temp file
â””â”€ State management

components/DocumentRelevanceDialog.tsx
â”œâ”€ Displays relevance check results
â”œâ”€ Shows confidence, analysis, missing items
â””â”€ Two action buttons (confirm/reject)

lib/api.ts
â”œâ”€ apiUploadCaseDocument() [MODIFIED]
â”‚  â””â”€ Added: confirmed parameter
â””â”€ apiDeleteTempDocument() [NEW]
   â””â”€ Delete temp files
```

## Data Flow Examples

### Example 1: High Confidence (Auto-Approve)
```
User uploads: "diagnostic_report.pdf"
â†“
Extract text: "××‘×—× ×ª ADHD ××¡×•×’ ××©×•×œ×‘, ×¨××™×•×Ÿ ×§×œ×™× ×™..."
â†“
Analyze: summary, key_points, structured_data
â†“
Upload to storage: cases/123/documents/20260129_123456_report.pdf
â†“
Relevance check:
  Required: "Physician's ADHD diagnostic report"
  Confidence: 92% âœ…
â†“
Save to database immediately
â†“
Return: {status: "ok", document: {...}}
```

### Example 2: Low Confidence (Needs Confirmation)
```
User uploads: "blood_test_results.pdf"
â†“
Extract text: "×ª×•×¦××•×ª ×‘×“×™×§×•×ª ×“×..."
â†“
Analyze: summary, key_points, structured_data
â†“
Upload to storage: cases/123/documents/20260129_123456_blood.pdf
â†“
Relevance check:
  Required: "Physician's ADHD diagnostic report"
  Confidence: 35% âŒ
  Missing: ["××‘×—× ×ª ADHD", "×¨××™×•×Ÿ ×§×œ×™× ×™", "×ª×™×¢×•×“ ×ª×¡××™× ×™×"]
â†“
Return: {status: "needs_confirmation", relevance_check: {...}}
â†“
Show dialog to user:
  âš ï¸ "×”××¡××š ×¢×©×•×™ ×œ× ×œ×”×ª××™× ×œ×“×¨×™×©×•×ª"
  Missing items listed
  Recommendations provided
â†“
User chooses:
  â”œâ”€ "Upload Anyway" â†’ Re-upload with confirmed=true â†’ Save to DB
  â””â”€ "Cancel" â†’ Delete from storage â†’ Allow re-upload
```

## Security & Access Control

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Every Request                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. JWT Token Validation            â”‚
â”‚     â””â”€ require_auth() dependency    â”‚
â”‚                                     â”‚
â”‚  2. Case Access Check               â”‚
â”‚     â”œâ”€ User owns case?              â”‚
â”‚     â””â”€ OR user is admin?            â”‚
â”‚                                     â”‚
â”‚  3. Storage Path Validation         â”‚
â”‚     â””â”€ Path starts with             â”‚
â”‚        "cases/{case_id}/"?          â”‚
â”‚                                     â”‚
â”‚  4. User Profile Existence          â”‚
â”‚     â””â”€ get_profile_by_user_id()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Legend:**
- â˜… NEW â˜… = Newly implemented feature
- âœ… = Approved/Success path
- âŒ = Rejected/Error path
- âš ï¸ = Warning/Confirmation needed
